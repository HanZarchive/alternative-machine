<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Alternative Machine</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Text+Me+One:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <div id="control-panel">
        <h1>Tolerance of REPETITION</h1>
        
        <div class="input-group">
            <label>Input a word you like:</label>
            <input type="text" id="wordInput" value="All work and no play makes Jack a dull boy" maxlength="50">
        </div>

        <div id="live-preview">
            <div id="preview-text" class="preview-content"></div>
        </div>

        <div class="input-group">
            <label>Repetition<span id="val-rep">0</span></label>
            <input type="range" id="repSlider" min="1" max="500" value="50">
        </div>
        <div class="input-group">
            <label>Density<span id="val-den">0</span></label>
            <input type="range" id="denSlider" min="0" max="100" value="0">
        </div>
        <div class="input-group">
            <label>Distortion<span id="val-dis">0</span></label>
            <input type="range" id="disSlider" min="0" max="100" value="0">
        </div>

        <button id="record-btn">Record Breaking Point</button>
    </div>

    <div id="visualization-wall">
        <h2 style="width:100%; color: #888;">COLLECTIVE THRESHOLDS (TOPOGRAPHY)</h2>
        
        <div id="viz-canvas"></div>

        <div id="detail-panel" style="display:none;"></div>
    </div>

    <script>
        const socket = io();

        const inputs = {
            word: document.getElementById('wordInput'),
            rep: document.getElementById('repSlider'),
            den: document.getElementById('denSlider'),
            dis: document.getElementById('disSlider'),
        };
        const displays = {
            rep: document.getElementById('val-rep'),
            den: document.getElementById('val-den'),
            dis: document.getElementById('val-dis'),
        };
        const preview = document.getElementById('preview-text');
        const wall = document.getElementById('visualization-wall');
        const btn = document.getElementById('record-btn');

        let allData = [];
        let selectedSample = null;

        function generateDistortedHTML(word, count, dis) {
            let html = '';
            let safeCount = count > 600 ? 600 : count; 
            
            for(let i=0; i<safeCount; i++) {
                let style = '';
                if (dis > 0) {
                    const skew = (Math.random() - 0.5) * dis / 1.5;
                    const scaleY = 1 + (Math.random() * dis / 100);
                    const translateY = (Math.random() - 0.5) * (dis / 3);
                    style = `style="transform: skew(${skew}deg) scaleY(${scaleY}) translateY(${translateY}px)"`;
                }
                html += `<span class="distorted-word" ${style}>${word} </span>`;
            }
            return html;
        }

        function generateStyle(params) {
            const den = parseInt(params.density);
            const dis = parseInt(params.distortion);
            return {
                letterSpacing: (0 - (den / 10)) + 'px', 
                lineHeight: (1.2 - (den / 80)),
                color: (dis > 85) ? '#d00' : '#1a1a1a'
            };
        }

        function updateLivePreview() {
            const word = inputs.word.value;
            const rep = parseInt(inputs.rep.value);
            const den = inputs.den.value;
            const dis = parseInt(inputs.dis.value);
            
            displays.rep.innerText = rep;
            displays.den.innerText = den + '%';
            displays.dis.innerText = dis + '%';
            
            const htmlContent = generateDistortedHTML(word, rep, dis);
            preview.innerHTML = htmlContent;
            
            const styles = generateStyle({ density: den, distortion: dis });
            Object.assign(preview.style, styles);
        }

        Object.values(inputs).forEach(el => el.addEventListener('input', updateLivePreview));
        updateLivePreview(); // 初始化左侧预览

        // --- 提交数据 ---
        btn.addEventListener('click', () => {
            const data = {
                word: inputs.word.value,
                repetition: inputs.rep.value,
                density: inputs.den.value,
                distortion: inputs.dis.value,
            };
            socket.emit('submit_threshold', data);
            
            const originalText = btn.innerText;
            btn.innerText = "RECORDED";
            btn.style.background = "#d00";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.background = ""; 
            }, 1000);
        });

        const clearBtn = document.createElement('button');
        clearBtn.innerText = 'Clear All Data';
        clearBtn.style.cssText = `
            position: fixed; bottom: 20px; right: 20px; padding: 10px 20px;
            background: #ff4444; color: white; border: none; cursor: pointer;
            font-family: 'JetBrains Mono', monospace; font-weight: bold; z-index: 1000;
        `;
        clearBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete ALL data?')) {
                socket.emit('clear_all_data');
            }
        });
        document.body.appendChild(clearBtn);
        
        function renderVisualization() {
            let xData = [], yData = [], zData = [], textData = [];
            
            if (allData.length > 0) {
                 xData = allData.map(d => d.params.density);
                 yData = allData.map(d => d.params.distortion);
                 zData = allData.map(d => d.params.repetition);
                 textData = allData.map(d => `Word: ${d.word}<br>Repetition: ${d.params.repetition}`);
            }

            const trace = {
                x: xData,
                y: yData,
                z: zData,
                text: textData,
                mode: 'markers',
                type: 'mesh3d', // 使用 mesh3d 模拟地形
                intensity: zData, // 颜色根据高度(Repetition)变化
                colorscale: 'Portland', // 使用类似参考图的热力图配色
                opacity: 0.9,
                flatshading: true,
                hoverinfo: 'text+x+y+z'
            };

            // 布局 Layout (黑夜模式)
            const layout = {
                autosize: true,
                paper_bgcolor: 'rgba(0,0,0,0)', // 透明背景
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { l: 0, r: 0, b: 0, t: 0 },
                scene: {
                    xaxis: { title: 'Density', color: '#888', gridcolor: '#444' },
                    yaxis: { title: 'Distortion', color: '#888', gridcolor: '#444' },
                    zaxis: { title: 'Repetition Limit', color: '#888', gridcolor: '#444' },
                    camera: { eye: {x: 1.5, y: 1.5, z: 1.2} }
                }
            };

            const config = { displayModeBar: false, responsive: true };

            // 绘制图表
            Plotly.newPlot('viz-canvas', [trace], layout, config);

            // 绑定点击事件用于显示详情
            document.getElementById('viz-canvas').on('plotly_click', function(data){
                const pointIndex = data.points[0].pointNumber;
                showDetail(allData[pointIndex]);
            });
            
            // 确保详情面板存在（如果是空数据状态）
            if (!document.getElementById('detail-panel')) {
                 const panel = document.createElement('div');
                 panel.id = 'detail-panel';
                 panel.style.display = 'none';
                 wall.appendChild(panel);
            }
        }

        // 显示详情 (保留原来的 HTML 生成逻辑)
        function showDetail(data) {
            selectedSample = data;
            const panel = document.getElementById('detail-panel');
            panel.style.display = 'block';
            
            // 复用原有的 generateDistortedHTML 生成右下角的预览
            const safeRep = Math.min(data.params.repetition, 200);
            const htmlContent = generateDistortedHTML(data.word, safeRep, data.params.distortion);
            
            const styles = generateStyle(data.params);
            const styleString = Object.entries(styles).map(([k, v]) => `${k}: ${v}`).join('; ');
            const date = new Date(data.timestamp).toLocaleString();
            
            panel.innerHTML = `
                <div style="display: flex; gap: 20px; position: relative;">
                    <button onclick="socket.emit('delete_entry', ${data.timestamp})" 
                            style="position: absolute; top: 0; right: 0; padding: 5px 15px; 
                                   background: #ff4444; color: white; border: none; cursor: pointer;
                                   font-family: 'JetBrains Mono', monospace;">
                        Delete
                    </button>
                    <div style="flex: 1; color: #ccc;">
                        <h3 style="color: #fff;">SAMPLE: ${data.word}</h3>
                        <p>Time: ${date}</p>
                        <p>Repetition: ${data.params.repetition}</p>
                        <p>Density: ${data.params.density}%</p>
                        <p>Distortion: ${data.params.distortion}%</p>
                        ${data.analysis ? `<p>Sentiment: ${data.analysis.sentiment}</p>` : ''}
                    </div>
                    <div style="flex: 2; overflow: hidden; max-height: 200px; border: 1px solid #444; padding: 10px; background: #eee;">
                        <div style="${styleString} font-size: 12px; color: #000;">${htmlContent}</div>
                    </div>
                </div>
            `;
        }

        // --- Socket 监听 ---
        socket.on('load_history', (history) => {
            allData = history;
            renderVisualization();
        });

        socket.on('new_data_point', (data) => {
            allData.push(data);
            renderVisualization();
        });

        socket.on('data_cleared', () => {
            allData = [];
            renderVisualization();
            const panel = document.getElementById('detail-panel');
            if(panel) panel.style.display = 'none';
            alert('All data cleared!');
        });

        socket.on('entry_deleted', (timestamp) => {
            allData = allData.filter(item => item.timestamp !== timestamp);
            renderVisualization();
            if (selectedSample && selectedSample.timestamp === timestamp) {
                document.getElementById('detail-panel').style.display = 'none';
                selectedSample = null;
            }
        });
        
        // 窗口大小调整时自适应
        window.onresize = function() {
            Plotly.Plots.resize('viz-canvas');
        };
    </script>
</body>
</html>